# 前端技术栈

<cite>
**本文档引用的文件**   
- [package.json](file://ui/package.json)
- [main.js](file://ui/src/main.js)
- [ChanApp.vue](file://ui/src/ChanApp.vue)
- [ChanContainer.vue](file://ui/src/components/ChanContainer.vue)
- [main.css](file://ui/src/main.css)
- [index.html](file://ui/public/index.html)
</cite>

## 目录
1. [项目概述](#项目概述)
2. [技术栈与依赖](#技术栈与依赖)
3. [项目结构](#项目结构)
4. [Vue.js 2.5 集成](#vuejs-25-集成)
5. [TradingView Charting Library 集成](#tradingview-charting-library-集成)
6. [RESTful API 通信](#restful-api-通信)
7. [入口文件初始化流程](#入口文件初始化流程)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [构建配置](#构建配置)

## 项目概述

本项目是一个基于Vue.js 2.5框架和TradingView Charting Library的前端应用，用于缠论量化研究的可视化展示。项目使用Vue CLI 3进行构建，通过RESTful API从Flask后端获取K线数据、缠论结构和买卖点信息，并在TradingView图表中进行渲染。前端采用Sass进行样式开发，使用axios进行HTTP通信。

**Section sources**
- [README.md](file://README.md#L2-L153)

## 技术栈与依赖

项目使用了以下主要技术栈和依赖：

- **Vue.js**: 版本 ~2.5.17，作为前端框架
- **axios**: 版本 ^0.21.0，用于HTTP通信
- **Vue CLI 3**: 用于项目构建和开发
- **Sass**: 用于样式开发
- **TradingView Charting Library**: 用于K线图表的渲染和交互

```json
{
  "dependencies": {
    "axios": "^0.21.0",
    "vue": "~2.5.17"
  },
  "devDependencies": {
    "@vue/cli-plugin-babel": "^3.9.2",
    "@vue/cli-plugin-eslint": "3.0.4",
    "@vue/cli-service": "^3.9.3",
    "node-sass": "4.14.1",
    "sass-loader": "~7.1.0"
  }
}
```

**Section sources**
- [package.json](file://ui/package.json#L1-L50)

## 项目结构

项目的主要目录结构如下：

```
ui/
├── public/
│   └── index.html
├── src/
│   ├── components/
│   │   └── ChanContainer.vue
│   ├── ChanApp.vue
│   ├── main.css
│   └── main.js
├── package.json
└── README.md
```

其中，`public/index.html`是应用的入口HTML文件，`src/main.js`是Vue应用的入口JavaScript文件，`src/ChanApp.vue`是根组件，`src/components/ChanContainer.vue`是包含TradingView图表的主要组件。

**Section sources**
- [README.md](file://README.md#L107-L136)

## Vue.js 2.5 集成

项目使用Vue.js 2.5.17作为前端框架，通过Vue CLI 3进行构建。Vue实例在`main.js`中创建，并挂载到DOM元素上。

```javascript
import Vue from 'vue';
import App from './ChanApp.vue'
import './main.css';

Vue.config.productionTip = false

new Vue({
  render: h => h(App)
}).$mount('#app')
```

**Section sources**
- [main.js](file://ui/src/main.js#L1-L12)

## TradingView Charting Library 集成

TradingView Charting Library通过`ChanContainer.vue`组件集成到Vue应用中。组件使用`widget`从`charting_library`导入，并在`mounted`生命周期钩子中初始化图表。

```javascript
import { widget } from '../../public/charting_library';

export default {
  name: 'ChanContainer',
  props: {
    symbol: {
      default: '000001.XSHG',
      type: String,
    },
    interval: {
      default: '1D',
      type: String,
    },
    containerId: {
      default: 'tv_chart_container',
      type: String,
    },
    datafeedUrl: {
      default: 'http://127.0.0.1:8421/api',
      type: String,
    },
    libraryPath: {
      default: '/charting_library/',
      type: String,
    },
    // ... 其他props
  },
  tvWidget: null,
  mounted() {
    const widgetOptions = {
      symbol: this.symbol,
      datafeed: new window.Datafeeds.UDFCompatibleDatafeed(this.datafeedUrl, 5000),
      interval: this.interval,
      container_id: this.containerId,
      library_path: this.libraryPath,
      // ... 其他选项
    };

    const tvWidget = new widget(widgetOptions);
    this.tvWidget = tvWidget;
    
    tvWidget.onChartReady(() => {
      // 图表准备就绪后的操作
      tvWidget.headerReady().then(() => {
        // 创建自定义按钮
        const btn_bs_point = tvWidget.createButton();
        btn_bs_point.setAttribute('title', '量化买卖');
        btn_bs_point.classList.add('apply-common-tooltip');
        btn_bs_point.addEventListener('click', function(){
          let sym = tvWidget.activeChart().symbol()
          let freq = tvWidget.activeChart().resolution()
          axios
            .get('http://127.0.0.1:8421/api/bzxd_mark?mtype=bspoint&tf='+freq+'&symbol='+sym)
            .then((resp) => {
              let bi_list = resp.data.data;
              console.table(bi_list)
              for(var item of bi_list){
                let dt = item['dt']
                let bs_type = item['bstype']
                let low = item['low']
                let high = item['high']
                if(bs_type =='short'){
                  tvWidget.chart(0).createShape(
                    {time: Date.parse(dt)/1000, price: high * 1.03}, 
                    {
                      shape: 'icon',
                      text: '开',
                      overrides: {
                        'color': '#EF534F',
                        'icon': '0xf01a',
                        'size': 20,
                      }
                    }
                  );
                }else if(bs_type =='long'){
                  tvWidget.chart(0).createShape(
                    {time: Date.parse(dt)/1000, price: low * 0.97},
                    {
                      shape: 'icon',
                      text: '开',
                      overrides: {
                        'color': '#27A69A',
                        'icon': '0xf01b',
                        'size': 20,
                      }
                    }
                  ); 
                }
              }
            });
        });
        btn_bs_point.innerHTML = '<font color="#00FFFF">量化买卖</font>';
      });
    });
  }
}
```

**Section sources**
- [ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L1-L2845)

## RESTful API 通信

前端通过axios与Flask后端进行RESTful API通信，获取K线数据、缠论结构和买卖点信息。主要的API端点包括：

- `/api/history`: 获取历史K线数据
- `/api/bzxd_mark`: 获取缠论结构标记
- `/api/bzzs_mark`: 获取中枢标记
- `/api/get_ocean_ind`: 获取海洋指标

```javascript
axios
  .get('http://127.0.0.1:8421/api/bzxd_mark?mtype=bspoint&tf='+freq+'&symbol='+sym)
  .then((resp) => {
    let bi_list = resp.data.data;
    console.table(bi_list)
    // 处理买卖点数据
  });
```

**Section sources**
- [ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L1-L2845)

## 入口文件初始化流程

`main.js`是Vue应用的入口文件，其初始化流程如下：

1. 导入Vue框架和根组件`ChanApp.vue`
2. 导入全局样式`main.css`
3. 禁用Vue生产提示
4. 创建Vue实例，使用render函数渲染根组件
5. 将Vue实例挂载到id为`app`的DOM元素上

```javascript
import Vue from 'vue';
import App from './ChanApp.vue'
import './main.css';

Vue.config.productionTip = false

new Vue({
  render: h => h(App)
}).$mount('#app')
```

**Section sources**
- [main.js](file://ui/src/main.js#L1-L12)

## 常见问题与解决方案

### TradingView SDK未正确复制导致的白屏问题

**问题描述**:
当TradingView的SDK文件没有正确复制到`public`目录时，图表会出现白屏现象。

**解决方案**:
1. 从 https://github.com/tradingview/charting_library/ 获取SDK
2. 解压后将`charting_library`目录复制到`ui/public/`目录
3. 将`charting_library.js`复制到`ui/src/`目录
4. 将`datafeeds`目录复制到`ui/public/`目录

```bash
# 复制SDK文件
cp -r charting_library ui/public/
cp charting_library.js ui/src/
cp -r datafeeds ui/public/
```

**Section sources**
- [README.md](file://ui/README.md#L1-L38)

## 构建配置

项目使用Vue CLI 3进行构建，配置了轻量级的构建环境。`package.json`中的scripts定义了开发和构建命令：

```json
{
  "scripts": {
    "serve": "vue-cli-service serve",
    "build": "vue-cli-service build",
    "lint": "vue-cli-service lint"
  }
}
```

构建配置选择了轻量级的依赖，如`node-sass`和`sass-loader`，以减少构建时间和包大小。同时，使用`@vue/cli-service`提供开发服务器和构建功能。

**Section sources**
- [package.json](file://ui/package.json#L1-L50)
- [README.md](file://ui/README.md#L1-L38)