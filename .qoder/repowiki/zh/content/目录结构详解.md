# 目录结构详解

<cite>
**本文档引用的文件**  
- [chanapi.py](file://api/chanapi.py)
- [symbol_info.py](file://api/symbol_info.py)
- [conf.py](file://comm/conf.py)
- [ChanContainer.vue](file://ui/src/components/ChanContainer.vue)
- [dtlib.py](file://utils/dtlib.py)
- [nlchan.py](file://utils/nlchan.py)
- [get_jqdata.py](file://hetl/stock/get_jqdata.py)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh)
- [binance_syms.txt](file://hetl/selcoin/binance_syms.txt)
- [replay_config.metadata.json](file://data/config/replay_config.metadata.json)
- [stock_names.metadata.json](file://data/stock/stock_names.metadata.json)
- [essence_xd_000001.XSHG_1d.metadata.json](file://data/nlchan/essence_xd_000001.XSHG_1d.metadata.json)
- [README.md](file://README.md)
</cite>

## 目录结构

- [项目结构概述](#项目结构概述)
- [api/ 目录](#api-目录)
  - [chanapi.py 功能说明](#chanapipy-功能说明)
  - [symbol_info.py 功能说明](#symbol_infopy-功能说明)
- [comm/ 目录](#comm-目录)
  - [conf.py 全局配置中心](#confpy-全局配置中心)
- [ui/ 目录](#ui-目录)
  - [Vue 组件结构](#vue-组件结构)
  - [TradingView 集成方式](#tradingview-集成方式)
- [hetl/ 目录](#hetl-目录)
  - [股票数据 ETL 脚本](#股票数据-etl-脚本)
  - [币圈数据 ETL 脚本](#币圈数据-etl-脚本)
  - [MongoDB 数据恢复脚本](#mongodb-数据恢复脚本)
- [data/ 目录](#data-目录)
  - [MongoDB 数据源结构](#mongodb-数据源结构)
- [utils/ 目录](#utils-目录)
  - [dtlib.py 工具函数](#dtlibpy-工具函数)
  - [nlchan.py 工具函数](#nlchanpy-工具函数)
- [pics/ 目录](#pics-目录)
- [高级功能模块](#高级功能模块)

## 项目结构概述

本项目为基于 TradingView 本地 SDK 的缠论量化研究可视化系统，采用前后端分离架构。前端基于 Vue 实现，后端使用 Flask 提供 API 接口，数据存储于 MongoDB。项目结构清晰，各模块职责分明，便于开发者快速定位功能模块和配置文件。

**Section sources**
- [README.md](file://README.md#L1-L153)

## api/ 目录

`api/` 目录是后端服务的核心，包含 Flask 应用的 API 接口实现，负责与前端 TradingView 组件通信，提供 K 线数据、缠论结构数据等。

### chanapi.py 功能说明

`chanapi.py` 是核心 API 文件，实现了 TradingView UDF (User Data Feed) 协议所需的所有接口，包括：
- `/api/config`：返回支持的分辨率、搜索功能等配置信息
- `/api/search`：支持在前端搜索股票和币种
- `/api/symbols`：获取指定符号的详细信息
- `/api/history`：提供 K 线历史数据，支持不同时间周期
- `/api/get_bspoint`：获取买卖点数据
- `/api/bzxd_mark` 和 `/api/bzzs_mark`：提供线段、中枢等缠论结构的标记点
- `/api/get_upper_fx`：获取更高级别的时间周期分型

该文件通过 `pymongo` 连接 MongoDB，从 `ohlcv`、`nlchan`、`stock` 等数据库中读取数据，并按 TradingView 要求的格式返回 JSON 响应。

**Section sources**
- [chanapi.py](file://api/chanapi.py#L1-L568)

### symbol_info.py 功能说明

`symbol_info.py` 负责构建前端 TradingView 可搜索和显示的资产列表。它从 `comm/conf.py` 中读取所有币种符号，并从 `stock` MongoDB 数据库中查询所有股票信息，将两者合并为统一的 `SUPPORT_SYMBOLS` 列表。该列表包含了资产的名称、代码、最小变动单位、价格精度等信息，使得前端可以正确显示和搜索各类资产。

**Section sources**
- [symbol_info.py](file://api/symbol_info.py#L1-L74)

## comm/ 目录

`comm/` 目录存放项目通用的配置和常量，是整个系统的配置中心。

### conf.py 全局配置中心

`conf.py` 是项目的全局配置文件，定义了：
- **路径配置**：`ROOT_PATH` 和 `DATA_PATH` 指向项目根目录和数据目录
- **时间周期映射**：`RESOU_DICT` 将前端分辨率（如 "1", "5"）映射到后端存储的周期标识（如 "1m", "5m"）
- **时间周期秒数**：`TF_SEC_MAP` 定义了各时间周期对应的秒数，用于计算 K 线数量
- **数据库连接**：通过 `pymongo` 连接到 `localhost:27017` 的 MongoDB，定义了 `CHAN_DB`、`HIST_DB`、`STOCK_DB`、`CONF_DB` 四个数据库实例
- **集合命名模板**：如 `ESSENCE_XD_COL` 用于动态生成存储线段数据的集合名称
- **资产列表**：从 `hetl/selcoin/binance_syms.txt` 文件中读取所有币种及其最小变动单位，构建 `ALL_SYMBOLS` 列表

该文件被 `api/` 和 `utils/` 目录下的多个模块导入，是系统运行的基础。

**Section sources**
- [conf.py](file://comm/conf.py#L1-L166)

## ui/ 目录

`ui/` 目录是前端 Vue 应用，负责与 TradingView SDK 集成，实现可视化界面。

### Vue 组件结构

前端采用 Vue 2.x 框架，主要组件结构如下：
- `src/main.js`：Vue 应用入口，挂载 `ChanApp.vue`
- `src/ChanApp.vue`：主应用组件，引入并渲染 `ChanContainer.vue`
- `src/components/ChanContainer.vue`：核心组件，负责初始化和配置 TradingView 图表

**Section sources**
- [main.js](file://ui/src/main.js#L1-L12)
- [ChanApp.vue](file://ui/src/ChanApp.vue#L1-L41)

### TradingView 集成方式

`ChanContainer.vue` 通过 `import { widget } from '../../public/charting_library';` 引入 TradingView 的 `charting_library`。在 `mounted()` 生命周期中，通过 `widgetOptions` 配置图表：
- `datafeed`：指向本地 Flask 服务的 API 地址 `http://127.0.0.1:8421/api`，使用 `UDFCompatibleDatafeed`
- `library_path`：指向 `public/charting_library/` 目录
- `custom_indicators_getter`：自定义了 `NMA`、`NMM`、`NMC` 等多个指标，这些指标通过 HTTP 请求从后端获取数据，实现了缠论相关指标的可视化

这种集成方式使得前端可以完全控制数据源，实现本地化部署和私有化数据展示。

**Section sources**
- [ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L1-L800)

## hetl/ 目录

`hetl/` 目录（History ETL）包含用于获取和处理历史数据的脚本，是数据管道的入口。

### 股票数据 ETL 脚本

`hetl/stock/get_jqdata.py` 脚本用于从聚宽 (JoinQuant) 平台获取股票数据：
- 使用 `jqdatasdk` 库进行认证和数据获取
- `get_all_secs()` 函数获取所有股票、指数、基金的基本信息，并存入 `stock` 数据库的 `stock_names` 集合
- `get_day_hist()` 函数获取指定股票的日线 K 线数据，处理后存入 `stk_{symbol}_1d` 格式的集合中
- `get_all_history()` 函数遍历所有股票，批量获取其历史数据

该脚本是填充 `data/stock/` 目录数据的主要工具。

**Section sources**
- [get_jqdata.py](file://hetl/stock/get_jqdata.py#L1-L100)

### 币圈数据 ETL 脚本

`hetl/selcoin/binance_syms.txt` 文件列出了所有支持的币种及其最小变动单位（minmov）。该文件被 `comm/conf.py` 读取，用于构建系统的币种列表。文件中的每一行包含币种符号和价格精度，例如 `BTC 0.01000000` 表示 BTC 的最小变动单位为 0.01。

**Section sources**
- [binance_syms.txt](file://hetl/selcoin/binance_syms.txt#L1-L118)

### MongoDB 数据恢复脚本

`hetl/hmgo/restore_chanvis_mongo.sh` 是一个 Shell 脚本，用于将 `data/` 目录下的 MongoDB 数据文件恢复到本地 MongoDB 实例中。开发者在首次部署时，可以运行此脚本来快速导入示例数据，避免从零开始获取大量历史数据。

**Section sources**
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L1-L1)

## data/ 目录

`data/` 目录是 MongoDB 数据库的数据文件目录，存储了所有持久化数据。

### MongoDB 数据源结构

`data/` 目录下包含多个子目录，对应不同的数据库：
- `config/`：存储 `config` 数据库的数据，如 `replay_config` 集合用于记录回放配置
- `nlchan/`：存储 `nlchan` 数据库的数据，包含缠论核心结构，如 `essence_xd_000001.XSHG_1d` 集合存储了上证指数日线级别的线段数据
- `stock/`：存储 `stock` 数据库的数据，包含股票 K 线和基本信息，如 `stk_000001.XSHG_1d` 存储 K 线，`stock_names` 存储股票名称

这些 `.metadata.json` 文件是 MongoDB 的集合元数据，定义了集合的索引等信息。整个 `data/` 目录的结构与 MongoDB 中的数据库和集合一一对应。

**Section sources**
- [replay_config.metadata.json](file://data/config/replay_config.metadata.json#L1-L1)
- [stock_names.metadata.json](file://data/stock/stock_names.metadata.json#L1-L1)
- [essence_xd_000001.XSHG_1d.metadata.json](file://data/nlchan/essence_xd_000001.XSHG_1d.metadata.json#L1-L1)

## utils/ 目录

`utils/` 目录存放项目通用的工具函数。

### dtlib.py 工具函数

`dtlib.py` 提供了日期和时间处理相关的工具函数：
- `time2int()` 和 `int2time()`：在字符串时间和 Unix 时间戳之间转换
- `gmt2int()` 和 `gmt2local()`：处理 GMT 时间格式
- `make_hist()`、`okex_make_hist()`、`binance_make_hist()`：将不同交易所的原始 K 线数据格式化为统一的内部格式
- `tomerge_15()`、`tomerge_60()`、`to_4hour()`：用于 K 线周期合并的辅助函数

这些函数被 `api/` 和 `hetl/` 目录的脚本广泛使用，确保了时间数据处理的一致性。

**Section sources**
- [dtlib.py](file://utils/dtlib.py#L1-L207)

### nlchan.py 工具函数

`nlchan.py` 包含与缠论相关的工具函数。目前只有一个 `sym_float(minmov)` 函数，用于根据最小变动单位（minmov）计算价格的小数点位数（`pricescale`）。例如，`minmov` 为 `0.01` 时，返回 `100`，这与 TradingView 配置中的 `pricescale` 字段对应。

**Section sources**
- [nlchan.py](file://utils/nlchan.py#L1-L25)

## pics/ 目录

`pics/` 目录用于存放项目的效果图和图片资源。根据 `README.md` 文件，该目录包含 `quanzi.jpg`（圈子图片）、`sz000001.jpg`（大盘效果图）和 `stock_demo.png`（个股效果图）等文件，用于在文档中展示系统的可视化效果。

**Section sources**
- [README.md](file://README.md#L20-L80)

## 高级功能模块

项目中还包含一些高级功能模块：
- `.swarm/` 和 `.claude-flow/` 目录：根据项目结构，这两个隐藏目录支持 AI 智能体系统，可能用于自动化交易策略的开发、测试或部署，是项目智能化的扩展部分。
- `CLAUDE.md` 文件：在多个目录下存在，可能是与 Claude AI 系统交互的说明或配置文件，表明项目集成了 AI 辅助开发或分析的能力。

这些模块展示了项目不仅是一个可视化工具，还具备向智能化、自动化交易系统发展的潜力。

**Section sources**
- [README.md](file://README.md#L1-L153)
- [项目结构](file://#L1-L153)