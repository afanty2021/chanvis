# 常见问题与故障排除

<cite>
**本文档引用文件**  
- [README.md](file://README.md#L139-L142)
- [ui/public/index.html](file://ui/public/index.html)
- [comm/conf.py](file://comm/conf.py#L143-L147)
- [api/chanapi.py](file://api/chanapi.py)
- [ui/src/components/ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L1637-L1645)
- [ui/README.md](file://ui/README.md#L3-L10)
- [hetl/hmgo/restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh)
- [data/config/replay_config.metadata.json](file://data/config/replay_config.metadata.json)
- [data/stock/replay_config.metadata.json](file://data/stock/replay_config.metadata.json)
</cite>

## 目录

1. [前端图表画线错位问题](#前端图表画线错位问题)  
2. [TradingView SDK未找到错误](#tradingview-sdk未找到错误)  
3. [MongoDB连接失败](#mongodb连接失败)  
4. [API返回空数据](#api返回空数据)  
5. [数据导入失败](#数据导入失败)  
6. [日志查看方法与调试技巧](#日志查看方法与调试技巧)  
7. [社区支持渠道](#社区支持渠道)

## 前端图表画线错位问题

当K线尚未完全加载完成时，系统可能提前触发画线功能，导致线段绘制在图表边框上，形成视觉错位。此问题在首次加载或刷新页面时尤为明显。

**解决方案**：  
刷新整个页面，确保K线数据完全加载后再进行画线操作。该问题为已知缺陷，目前尚无自动修复机制。

**Section sources**  
- [README.md](file://README.md#L139-L140)
- [ui/src/components/ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L1637-L1645)

## TradingView SDK未找到错误

若系统提示“TradingView SDK未找到”或相关资源加载失败，通常是由于`public`目录结构不完整所致。

**检查步骤**：  
1. 确认`ui/public/`目录下是否存在`charting_library/`和`datafeeds/`两个子目录。  
2. 确保`charting_library/`目录包含完整的SDK文件（如`charting_library.js`等）。  
3. 确保`datafeeds/`目录包含`udf/dist/`路径下的`polyfills.js`和`bundle.js`文件。

**修复方法**：  
从官方或合法途径获取TradingView SDK，解压后将`charting_library`和`datafeeds`文件夹复制到`ui/public/`目录下。

**Section sources**  
- [ui/README.md](file://ui/README.md#L3-L10)
- [ui/public/index.html](file://ui/public/index.html#L7-L8)

## MongoDB连接失败

系统无法连接MongoDB数据库时，可能由以下原因导致：

1. **MongoDB服务未启动**：  
   确保MongoDB服务正在运行。可通过命令`mongod`启动服务，或使用系统服务管理工具（如`systemctl`）启动。

2. **连接字符串错误**：  
   检查`comm/conf.py`文件中的MongoDB连接配置：
   ```python
   client = MongoClient('localhost', 27017)
   ```
   确认主机地址和端口正确。若MongoDB运行在非默认端口或远程服务器，需相应修改。

3. **数据库权限问题**：  
   确保运行用户对MongoDB数据目录有读写权限。

**验证连接**：  
可使用`mongo`命令行工具连接`localhost:27017`测试连通性。

**Section sources**  
- [comm/conf.py](file://comm/conf.py#L143-L147)
- [api/chanapi.py](file://api/chanapi.py#L19-L21)

## API返回空数据

当API接口（如`/api/history`）返回空数据时，可能原因如下：

1. **集合名称错误**：  
   检查请求的`symbol`和`resolution`参数是否正确。系统根据`{symbol}_{tf}`格式查找集合，如`stk_000001.XSHG_1d`。

2. **查询条件超出范围**：  
   确认`from`和`to`时间戳在数据范围内。可通过`replay_config`集合查看当前数据的最新时间戳。

3. **数据库中无对应数据**：  
   确认MongoDB中已导入相应数据。例如，股票数据应存在于`stock`数据库中，缠论结构数据在`nlchan`数据库中。

**调试建议**：  
在`api/chanapi.py`的`history()`函数中添加日志输出，检查查询条件和数据库响应。

**Section sources**  
- [api/chanapi.py](file://api/chanapi.py#L173-L177)
- [data/config/replay_config.metadata.json](file://data/config/replay_config.metadata.json)
- [data/stock/replay_config.metadata.json](file://data/stock/replay_config.metadata.json)

## 数据导入失败

数据导入失败通常与BSON文件路径或权限有关。

**检查步骤**：  
1. **确认BSON文件路径**：  
   确保`data/`目录下存在正确的BSON文件，如`data/nlchan/essence_xd_000001.XSHG_1d.bson`。

2. **检查文件权限**：  
   运行`mongorestore`的用户需对`data/`目录及子文件有读取权限。

3. **执行导入脚本**：  
   使用提供的脚本进行数据恢复：
   ```bash
   ./hetl/hmgo/restore_chanvis_mongo.sh
   ```
   该脚本会自动导入`stock`、`config`和`nlchan`数据库的数据。

**常见错误**：  
- `Failed: config.replay_config: error reading bson: EOF`：表示BSON文件损坏或不完整，请重新下载或导出。
- 权限拒绝：使用`chmod`或`chown`命令修复文件权限。

**Section sources**  
- [hetl/hmgo/restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh)
- [data/CLAUDE.md](file://data/CLAUDE.md#L85-L89)

## 日志查看方法与调试技巧

系统在运行过程中会输出关键日志信息，用于诊断问题。

**日志输出位置**：  
- **后端日志**：`api/chanapi.py`中使用`print()`函数输出日志，如：
  ```python
  print(f'GET DATA: [{symbol}] [{resolution}] [{_xfrom}] - [{_xto}], Length: {len(res)}, Latest: {lts}')
  ```
  运行Flask应用时，这些日志将显示在控制台。

- **前端日志**：`ui/src/components/ChanContainer.vue`中使用`console.log()`输出调试信息，如：
  ```javascript
  console.log('baihuo: New history bars are loaded')
  ```
  可通过浏览器开发者工具的Console面板查看。

**调试技巧**：  
- 在关键函数入口添加`print()`或`console.log()`输出参数和状态。  
- 使用`pprint()`打印复杂数据结构，便于分析。  
- 启用Flask调试模式（`debug=True`）以获取更详细的错误信息。

**Section sources**  
- [api/chanapi.py](file://api/chanapi.py#L211-L212)
- [ui/src/components/ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L1639)

## 社区支持渠道

如遇无法解决的问题，可通过以下渠道寻求帮助：

- **Telegram群组**：https://t.me/+trsm24TgH1E0N2Q1  
  这是项目作者提供的主要交流平台，可用于咨询问题、获取授权或分享经验。

- **联系作者**：  
  在系统界面点击“联系作者”按钮，可查看作者微信（quantchan）等联系方式。

- **参考文档**：  
  TradingView中文文档：https://aitrade.ga/books/tradingview/

**Section sources**  
- [README.md](file://README.md#L12)
- [ui/src/components/ChanContainer.vue](file://ui/src/components/ChanContainer.vue#L2547-L2554)