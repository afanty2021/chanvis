# 数据库连接配置

<cite>
**本文引用的文件**
- [conf.py](file://comm/conf.py)
- [chanapi.py](file://api/chanapi.py)
- [symbol_info.py](file://api/symbol_info.py)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh)
- [requirements.txt](file://api/requirements.txt)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本文件聚焦于项目中MongoDB客户端连接配置与数据库实例用途，围绕以下目标展开：
- 解释MongoDB客户端初始化参数含义
- 明确CHAN_DB、HIST_DB、STOCK_DB、CONF_DB四个数据库实例的职责边界
- 提供连接字符串修改建议（认证、远程、副本集）
- 给出连接池配置与异常处理最佳实践

## 项目结构
- 数据库连接与全局配置集中在comm/conf.py中，被API层（api/chanapi.py、api/symbol_info.py）广泛使用
- 数据导入导出脚本位于hetl/hmgo/restore_chanvis_mongo.sh，展示了各数据库命名空间的使用
- 项目使用pymongo作为MongoDB驱动，API层通过Flask对外提供服务

```mermaid
graph TB
subgraph "配置与连接"
C["comm/conf.py<br/>创建MongoClient并绑定数据库实例"]
end
subgraph "API层"
A1["api/chanapi.py<br/>历史数据查询/买卖点/中枢标记等"]
A2["api/symbol_info.py<br/>股票名称查询"]
end
subgraph "数据与脚本"
D1["data/stock/*<br/>股票数据集合"]
D2["data/nlchan/*<br/>缠论结构数据集合"]
S1["hetl/hmgo/restore_chanvis_mongo.sh<br/>导入/导出脚本"]
end
C --> A1
C --> A2
A1 --> D1
A1 --> D2
A2 --> D1
S1 -.-> D1
S1 -.-> D2
```

图表来源
- [conf.py](file://comm/conf.py#L143-L147)
- [chanapi.py](file://api/chanapi.py#L1-L25)
- [symbol_info.py](file://api/symbol_info.py#L1-L10)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)

章节来源
- [conf.py](file://comm/conf.py#L143-L147)
- [chanapi.py](file://api/chanapi.py#L1-L25)
- [symbol_info.py](file://api/symbol_info.py#L1-L10)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)
- [README.md](file://README.md#L90-L100)

## 核心组件
- MongoDB客户端与数据库实例
  - 在comm/conf.py中创建MongoClient('localhost', 27017)，随后将不同数据库实例绑定到client对象上，分别用于不同业务域
  - 具体绑定位置：client.nlchan、client.ohlcv、client.stock、client.config
  - 对应的全局变量：CHAN_DB、HIST_DB、STOCK_DB、CONF_DB

- 数据库实例用途
  - CHAN_DB：存储缠论结构数据（如线段、中枢等分析结果）
  - HIST_DB：存储原始K线数据（OHLCV）
  - STOCK_DB：存储股票基础信息（如股票名称映射）
  - CONF_DB：存储系统配置（如回放配置replay_config）

- 使用示例（来自API层）
  - 历史数据查询：根据symbol类型选择HIST_DB或STOCK_DB，并按时间周期拼接集合名进行查询
  - 股票名称查询：从STOCK_DB.stock_names读取股票基础信息
  - 缠论标记与买卖点：从CHAN_DB中读取线段/中枢等结构化结果
  - 回放配置：从CONF_DB.replay_config读取当前时间戳与回放状态

章节来源
- [conf.py](file://comm/conf.py#L143-L147)
- [chanapi.py](file://api/chanapi.py#L96-L235)
- [symbol_info.py](file://api/symbol_info.py#L45-L70)

## 架构总览
下图展示MongoDB客户端、数据库实例与API层之间的交互关系：

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "Flask接口(chanapi.py)"
participant Conf as "配置(conf.py)"
participant Mongo as "MongoDB"
participant Hist as "HIST_DB(原始K线)"
participant Stock as "STOCK_DB(股票信息)"
participant Chan as "CHAN_DB(缠论结构)"
participant ConfDB as "CONF_DB(系统配置)"
Client->>API : 请求历史数据/标记/配置
API->>Conf : 引入数据库实例(HIST_DB/STOCK_DB/CHAN_DB/CONF_DB)
API->>Mongo : 查询集合(按symbol+tf拼接集合名)
Mongo-->>API : 返回数据
API-->>Client : 返回JSON响应
```

图表来源
- [chanapi.py](file://api/chanapi.py#L96-L235)
- [conf.py](file://comm/conf.py#L143-L147)

## 详细组件分析

### 组件A：MongoDB客户端与连接参数
- 初始化方式
  - 使用MongoClient('localhost', 27017)创建客户端
  - 该方式默认连接本机27017端口，无认证凭据
- 参数含义
  - 主机名：'localhost'表示连接本机MongoDB实例
  - 端口号：27017为MongoDB默认端口
- 连接字符串扩展建议
  - 认证：在连接字符串中加入用户名与密码，例如mongodb://username:password@host:port/db
  - 远程连接：将主机名改为远端IP或域名
  - 副本集：在连接字符串末尾追加副本集名称与选项，例如mongodb://host1:port1,host2:port2,host3:port3/db?replicaSet=rs0
  - 注意：以上为通用建议，具体格式请参考pymongo官方文档与实际环境配置

```mermaid
flowchart TD
Start(["开始"]) --> Build["构建连接字符串"]
Build --> Auth{"是否需要认证?"}
Auth --> |是| AddCred["加入用户名/密码"]
Auth --> |否| SkipCred["跳过认证"]
AddCred --> Remote{"是否远程连接?"}
SkipCred --> Remote
Remote --> |是| AddHost["替换为远端主机/域名"]
Remote --> |否| Local["保持localhost"]
AddHost --> RS{"是否副本集?"}
Local --> RS
RS --> |是| AddRS["追加副本集参数"]
RS --> |否| NoRS["不追加副本集参数"]
AddRS --> End(["完成"])
NoRS --> End
```

图表来源
- [conf.py](file://comm/conf.py#L143-L147)

章节来源
- [conf.py](file://comm/conf.py#L143-L147)

### 组件B：数据库实例与集合命名规范
- 数据库实例绑定
  - CHAN_DB = client.nlchan
  - HIST_DB = client.ohlcv
  - STOCK_DB = client.stock
  - CONF_DB = client.config
- 集合命名规范
  - 历史K线集合：{symbol}_{tf}（如 btc_1d、stk_000001.XSHG_1d）
  - 缠论结构集合：essence_xd_{sym}_{tf}、essence_zs_{sym}_{tf}、lnchan_xd_{sym}_{tf}、lnchan_zs_{sym}_{tf} 等
  - 股票名称集合：stock_names
  - 回放配置集合：replay_config

```mermaid
erDiagram
NLCHAN ||--o{ ESSENCE_XD : "essence_xd_{sym}_{tf}"
NLCHAN ||--o{ ESSENCE_ZS : "essence_zs_{sym}_{tf}"
NLCHAN ||--o{ LNCHAN_XD : "lnchan_xd_{sym}_{tf}"
NLCHAN ||--o{ LNCHAN_ZS : "lnchan_zs_{sym}_{tf}"
OHLCV ||--o{ HIST_KLINE : "{symbol}_{tf}"
STOCK ||--o{ STOCK_NAMES : "stock_names"
CONFIG ||--o{ REPLAY_CONFIG : "replay_config"
```

图表来源
- [conf.py](file://comm/conf.py#L143-L158)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)

章节来源
- [conf.py](file://comm/conf.py#L143-L158)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)

### 组件C：API层对数据库的使用流程
- 历史数据查询
  - 根据symbol类型选择HIST_DB或STOCK_DB
  - 按分辨率映射到tf，拼接集合名进行查询
  - 结合CONF_DB.replay_config控制回放时间范围
- 股票名称查询
  - 从STOCK_DB.stock_names读取股票基础信息
- 缠论标记与买卖点
  - 从CHAN_DB读取线段/中枢等结构化结果
- 回放配置
  - 读写CONF_DB.replay_config，记录当前symbol、tf与时间戳

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "chanapi.history()"
participant Conf as "CONF_DB"
participant Hist as "HIST_DB"
participant Stock as "STOCK_DB"
participant Chan as "CHAN_DB"
Client->>API : GET /api/history?symbol=&from=&to=&resolution=
API->>Conf : 读取replay_config(当前symbol/tf/ts)
API->>API : 判断symbol类型(股票/币)
API->>Hist : 查询{symbol}_{tf}集合(按ts范围)
Hist-->>API : 返回K线数据
API-->>Client : 返回JSON(时间序列)
```

图表来源
- [chanapi.py](file://api/chanapi.py#L96-L235)

章节来源
- [chanapi.py](file://api/chanapi.py#L96-L235)

### 组件D：股票基础信息与系统配置
- 股票基础信息
  - 从STOCK_DB.stock_names读取股票代码、显示名称等
  - 用于前端symbol搜索与展示
- 系统配置
  - CONF_DB.replay_config用于记录回放进度与当前时间戳
  - 用于控制历史数据查询的时间窗口与部分K线处理

章节来源
- [symbol_info.py](file://api/symbol_info.py#L45-L70)
- [chanapi.py](file://api/chanapi.py#L118-L131)

## 依赖关系分析
- 外部依赖
  - 使用pymongo作为MongoDB驱动
- 内部依赖
  - API层依赖comm/conf.py中的数据库实例
  - 数据导入导出脚本依赖各数据库命名空间

```mermaid
graph LR
Pymongo["pymongo(驱动)"] --> Conf["comm/conf.py"]
Conf --> ChanAPI["api/chanapi.py"]
Conf --> SymbolInfo["api/symbol_info.py"]
Restore["hetl/hmgo/restore_chanvis_mongo.sh"] --> DataStock["data/stock/*"]
Restore --> DataNlchan["data/nlchan/*"]
```

图表来源
- [requirements.txt](file://api/requirements.txt#L1-L9)
- [conf.py](file://comm/conf.py#L143-L147)
- [chanapi.py](file://api/chanapi.py#L1-L25)
- [symbol_info.py](file://api/symbol_info.py#L1-L10)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)

章节来源
- [requirements.txt](file://api/requirements.txt#L1-L9)
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)

## 性能考量
- 连接池配置
  - 建议在生产环境中启用连接池，合理设置最大连接数与超时参数，避免频繁创建/销毁连接
  - 对高频查询（如历史数据）可考虑使用索引优化（按ts升序/降序）
- 并发访问
  - API层并发请求较多时，确保MongoDB实例具备足够的资源与合理的分片/副本集配置
- 数据规模
  - K线数据体量较大，建议对集合建立合适的索引与分区策略，减少全表扫描

## 故障排查指南
- 连接失败
  - 检查MongoDB服务是否运行、端口是否开放
  - 若启用认证，确认连接字符串中的用户名/密码正确
  - 若为远程连接，确认防火墙与网络策略允许访问
- 权限问题
  - 确认用户对目标数据库/集合具备读写权限
- 集合不存在
  - 确认restore脚本已成功导入所需集合
- 查询性能差
  - 检查是否缺少索引（如按ts排序/过滤）
  - 分析查询条件与集合大小，必要时拆分集合或增加分区

章节来源
- [restore_chanvis_mongo.sh](file://hetl/hmgo/restore_chanvis_mongo.sh#L22-L30)

## 结论
- 本项目通过单一MongoClient实例统一管理多个业务数据库，CHAN_DB/HIST_DB/STOCK_DB/CONF_DB分别承载缠论结构、原始K线、股票基础信息与系统配置
- 连接参数默认指向本机27017端口，可通过连接字符串扩展支持认证、远程与副本集
- 建议在生产环境完善连接池、索引与权限配置，并结合脚本进行数据导入导出